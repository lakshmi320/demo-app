- name: Deploy to EC2 Minikube (update image to SHA, apply, rollout)
      uses: appleboy/ssh-action@v1.2.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          set -e
          kubectl config use-context minikube || true

          echo "ğŸ”§ Updating image in deployment.yaml to SHA: ${{ github.sha }}"
          sed -i "s#^\(\s*image:\s*\).*#\1${{ secrets.DOCKER_REPO }}:${{ github.sha }}#g" /home/ec2-user/demo-app/deployment.yaml

          echo "ğŸ“¦ Applying deployment.yaml"
          kubectl apply -f /home/ec2-user/demo-app/deployment.yaml

          echo "ğŸ” Rolling out deployment demo-app-deployment"
          kubectl rollout restart deployment demo-app-deployment

          echo "â³ Waiting for rollout to finishâ€¦"
          kubectl rollout status deployment/demo-app-deployment --timeout=180s

          echo "ğŸ” Verifying final image on cluster:"
          kubectl get deploy demo-app-deployment -o jsonpath='{.spec.template.spec.containers[0].image}'; echo
