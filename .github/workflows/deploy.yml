name: CI/CD to EC2 (K8s, SHA tagging)

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1) Checkout repo
    - name: Checkout code
      uses: actions/checkout@v4


    ###############################################
    # 2) SONARQUBE ANALYSIS STEPS (ADD THESE)
    ###############################################

    - name: Set up JDK
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Cache SonarQube packages
      uses: actions/cache@v3
      with:
        path: ~/.sonar/cache
        key: ${{ runner.os }}-sonar
        restore-keys: ${{ runner.os }}-sonar

    - name: SonarQube Scan
      uses: SonarSource/sonarqube-scan-action@v2
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

    ###############################################
    # END SONAR STEPS
    ###############################################


    # 3) Login to Docker Hub
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 4) Build Docker image from demo-app/
    - name: Build Docker image (SHA + latest)
      run: |
        docker build -f demo-app/Dockerfile -t ${{ secrets.DOCKER_REPO }}:${{ github.sha }} demo-app
        docker tag  ${{ secrets.DOCKER_REPO }}:${{ github.sha }} ${{ secrets.DOCKER_REPO }}:latest

    # 5) Push both tags to Docker Hub
    - name: Push Docker image (SHA + latest)
      run: |
        docker push ${{ secrets.DOCKER_REPO }}:${{ github.sha }}
        docker push ${{ secrets.DOCKER_REPO }}:latest

    # 6) SSH into EC2 ‚Üí Deploy to Minikube
    - name: Deploy to EC2 Minikube (update image to SHA, apply, rollout)
      uses: appleboy/ssh-action@v1.2.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          set -e
          kubectl config use-context minikube || true

          echo "üîß Updating image in ~/deployment.yaml to SHA: ${{ github.sha }}"
          sed -i "s#^\(\s*image:\s*\).*#\1${{ secrets.DOCKER_REPO }}:${{ github.sha }}#g" ~/deployment.yaml

          echo "üì¶ Applying deployment.yaml"
          kubectl apply -f ~/deployment.yaml

          echo "üîÅ Rolling out deployment demo-app-deployment"
          kubectl rollout restart deployment demo-app-deployment

          echo "‚è≥ Waiting for rollout to finish‚Ä¶"
          kubectl rollout status deployment/demo-app-deployment --timeout=180s

          echo "üîç Final image version on cluster:"
          kubectl get deploy demo-app-deployment -o jsonpath='{.spec.template.spec.containers[0].image}'; echo
